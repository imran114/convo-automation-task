name: Convo Automation Task - Selenium CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'  # Runs daily at 2 AM UTC

jobs:
  selenium-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Chrome and ChromeDriver
        run: |
          set -e  # Exit immediately if any command fails

          echo "Updating system packages..."
          sudo apt update || true
          sudo apt upgrade -y || true
          sudo apt install -y google-chrome-stable jq unzip wget || true

          echo "Checking installed Chrome version..."
          CHROME_VERSION=$(google-chrome-stable --version | awk '{print $3}' | cut -d '.' -f1)
          echo "Installed Chrome version: $CHROME_VERSION"

          echo "Fetching ChromeDriver version for Chrome $CHROME_VERSION..."
          RESPONSE=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/latest-patch-versions-per-build-with-downloads.json")

          if [[ -z "$RESPONSE" || "$RESPONSE" == "null" ]]; then
              echo "Error: Failed to fetch ChromeDriver version."
              exit 1
          fi

          CHROMEDRIVER_VERSION=$(echo "$RESPONSE" | jq -r --arg CHROME_VERSION "$CHROME_VERSION" '.[$CHROME_VERSION].downloads.chromedriver[0].version')

          if [[ -z "$CHROMEDRIVER_VERSION" || "$CHROMEDRIVER_VERSION" == "null" ]]; then
              echo "Warning: No exact ChromeDriver version found for Chrome $CHROME_VERSION."
              echo "Fetching latest ChromeDriver version instead..."
              CHROMEDRIVER_VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/latest-patch-versions-per-build-with-downloads.json | jq -r '.["134"].downloads.chromedriver[0].version')

              if [[ -z "$CHROMEDRIVER_VERSION" || "$CHROMEDRIVER_VERSION" == "null" ]]; then
                  echo "Error: Could not determine a valid ChromeDriver version."
                  exit 1
              fi
          fi

          echo "Using ChromeDriver version: $CHROMEDRIVER_VERSION"
          
          echo "Downloading ChromeDriver..."
          wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROMEDRIVER_VERSION/linux64/chromedriver-linux64.zip"

          if [[ ! -f "chromedriver-linux64.zip" ]]; then
              echo "Error: ChromeDriver download failed."
              exit 1
          fi

          unzip -o chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/bin/chromedriver
          sudo chmod +x /usr/bin/chromedriver

          echo "Installed versions:"
          google-chrome-stable --version
          chromedriver --version

      - name: Display System Information
        run: |
          echo "System Information:"
          uname -a
          java -version
          mvn -version
          google-chrome-stable --version
          chromedriver --version

      - name: Install Maven Dependencies
        run: mvn clean install -DskipTests=true

      - name: Run Selenium TestNG Tests
        run: |
          echo "Resolving dependencies..."
          mvn dependency:resolve
          
          echo "Running Selenium TestNG tests..."
          mvn clean test -Dsurefire.suiteXmlFiles=./testng.xml -Dsurefire.rerunFailingTestsCount=2 --fail-at-end

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: target/surefire-reports
